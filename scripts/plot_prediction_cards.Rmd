---
title: "Flu Forecasts"
author: "Team Flu"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: html_document
params:
  exclude_geos: !r character(0L)
  predictions_file: !r character(0L)
---

```{r setup, include=FALSE, echo=FALSE}
source(here::here("R", "load_all.R"))

converted_healthdata_1d <- get_health_data(forecast_generation_date)
# Same as process_healthdata(), but without the population scaling and keep as 7 day sums
converted_healthdata_7d <- converted_healthdata_1d %>%
  group_by(geo_value) %>%
  tidyr::complete(time_value = tidyr::full_seq(time_value, period = 1L)) %>%
  ungroup() %>%
  as_epi_df() %>%
  group_by(geo_value) %>%
  epi_slide(
    before = 6L,
    ~ if (nrow(.x) == 7L) mean(.x$value) else NA_real_
  ) %>%
  ungroup() %>%
  mutate(
    value = slide_value,
    slide_value = NULL
  ) %>%
  as_tibble()

flu_forecasts <- read_csv(params$predictions_file, show_col_types = FALSE) %>%
  mutate(
    forecast_date = reference_date,
    quantile = output_type_id
  ) %>%
  filter(output_type != "pmf") %>%
  mutate(
    quantile = parse_number(quantile),
    geo_value = as.factor(geo_value),
  )
```

## Trajectory plots

- Fan displays 50/80/95% confidence intervals
- Black line is `confirmed_admissions_influenza_1d_7d`.

```{r, fig.height = 80, fig.width = 15, echo=FALSE}
# setup the plot and join corrections to the truth
plot_state_forecasters(
  flu_forecasts %>% filter(geo_value != "us"),
  exclude_geos = params$exclude_geos,
  start_day = "2022-10-01",
  ncol = 2,
  data_7dav_override = converted_healthdata_7d
) %>%
  suppressMessages() %>%
  suppressWarnings() %>%
  plotly::ggplotly()
```

```{r, fig.height = 10, fig.width = 15, echo=FALSE}
if ("us" %in% params$exclude_geos) {
  print("us excluded")
} else {
  # setup the plot and join corrections to the truth
  plot_nation_forecasters(
    flu_forecasts %>% filter(geo_value == "us"),
    exclude_geos = params$exclude_geos,
    start_day = "2022-10-01",
    data_7dav_override = converted_healthdata_7d
  ) %>%
    suppressMessages() %>%
    suppressWarnings() %>%
    plotly::ggplotly()
}
```
