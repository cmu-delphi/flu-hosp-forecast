---
title: "Flu Forecasts"
author: "Team Flu"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: html_document
---

```{r setup, include=FALSE, echo=FALSE}
library(evalcast)
library(zookeeper)
library(lubridate)
library(tidyverse)
library(readr)
library(aws.s3)
library(covidcast)
library(readr)
library(pipeR)
library(magrittr)

#### BEGIN copied/adapted from cmu-delphi/hospitalization-forecaster
source("plotting.R")

exclude_geos <- character(0L)
cache_dir <- Sys.getenv("FLU_CACHE", "exploration")
offline_signal_dir <- here::here(paste0("cache/", cache_dir, "/signals"))
if (Sys.getenv("FORECAST_DATE", "") != "") {
  forecast_dates <- as.Date(Sys.getenv("FORECAST_DATE")) - 1
} else {
  forecast_dates <- lubridate::today() - 1
}

plot_state_forecasters_ <- function(df) {
  plot_state_forecasters(df %>% filter(geo_value != "us"), exclude_geos = exclude_geos, start_day = "2022-01-01", ncol = 2, offline_signal_dir = offline_signal_dir) %>% suppressMessages() %>% suppressWarnings()
}

plot_nation_forecasters_ <- function(df) {
  plot_nation_forecasters(df %>% filter(geo_value == "us"), exclude_geos = exclude_geos, start_day = "2022-01-01", offline_signal_dir = offline_signal_dir) %>% suppressMessages() %>% suppressWarnings()
}
#### END copied/adapted from cmu-delphi/hospitalization-forecaster

predictions_file <- here::here("code", "data-forecasts", "CMU-TimeSeries", sprintf("%s-CMU-TimeSeries-prediction-cards.csv", forecast_date))
flu_forecasts <- read_csv(predictions_file, show_col_types = FALSE)
```

## Trajectory plots

* Fan displays 50/80/95% confidence intervals
* Black line is `confirmed_admissions_influenza_1d_7dav`.

```{r, fig.height = 80, fig.width = 15, echo=FALSE}
# setup the plot and join corrections to the truth
plot_state_forecasters_(flu_forecasts) %>% plotly::ggplotly()
```

```{r, fig.height = 10, fig.width = 15, echo=FALSE}
# setup the plot and join corrections to the truth
plot_nation_forecasters_(flu_forecasts) %>% plotly::ggplotly()
```

# Previous Forecasts {.tabset}

## Most Recent

```{r, echo=FALSE, fig.height = 80, fig.width = 15}
prev_week <- forecast_date - 7
df <- get_forecaster_predictions(prev_week)
plot_state_forecasters_(df %>% filter(forecast_date == prev_week)) %>% plotly::ggplotly()
```

## Two Weeks Back

```{r, echo=FALSE, fig.height = 80, fig.width = 15}
prev_week <- forecast_date - 14
df <- get_forecaster_predictions(prev_week)
plot_state_forecasters_(df %>% filter(forecast_date == prev_week)) %>% plotly::ggplotly()
```

## Three Weeks Back

```{r, echo=FALSE, fig.height = 80, fig.width = 15}
prev_week <- forecast_date - 21
df <- get_forecaster_predictions(prev_week)
plot_state_forecasters_(df %>% filter(forecast_date == prev_week)) %>% plotly::ggplotly()
```
